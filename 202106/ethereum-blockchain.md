# 以太坊与区块链技术

# Ethereum And BlockChain

## 2021 年 6 月 17 日

## Jun 17 2021



> 参考：[肖臻的比特币课程](https://www.bilibili.com/video/BV1Vt411X7JF)。



比特币和以太坊是两种主要的加密货币，比特币被称为区块链1.0，以太坊被称为区块链2.0。

1. 以太坊的改进之一是另一套共识协议：ghost。
2. 另外，以太坊设计了memory hard mining puzzle，这在一定程度上限制了ASIC芯片的使用，我们称为ASIC resistance。
3. 以太坊还将用权益证明（proof of stake）替代工作证明（proof of work）。
4. 以太坊还提供了一个重要的新功能，即对智能合约（smart contract）的支持。

比特币（BTC）是货币的去中心化，以太坊（ETH，Etherem）还提供了去中心化的合约的支持，以太坊中的币我们称为以太或以太币（Ether）；比特币的计量单位是一聪（satoshi），以太坊的计量单位是一*Wei*。

### 账户

比特币是没有账户的概念的，它使用UTXO记录交易，保存钱包。

> UTXO只要用了一次就会消失，所以转账后剩下的币要显示地转给自己，有些UTXO提供自动生成接收账户的功能，这样也有利于隐私保护，所谓“打一枪换一个地方”。

以太坊是基于账户的加密货币。优点如下，

1. 交易时不用说明币的来源，只需要扣钱就行。
2. 以太坊这种基于账户的模式，对double-spending有天然的防护作用，因为不用管币的来源，每花一次钱就扣一次，花两次（钱够的话）就扣两次。

缺点在于，需要抵抗重放攻击（reply attack）

> reply attack与double spending相对的概念，双花是花钱的人不诚实，它想同样的钱花两次；而重放是收钱的人不诚实，它想同样的钱收两次。

抵抗重放攻击的方法也很简单，每笔交易加一个计数器（nonce），需要支付者签名，后面的同样的账户转出的交易必须在计数器后面加一（这需要有支付者签名才能发起），才能有效执行。

以太坊有两类账户：合约账户（contract account）和外部账户（externally owned account）。

1. 外部账户：基于公私钥对的账户，这和比特币一样。它有两个变量：balance和nonce。
2. 合约账户：合约账户不能主动发起交易。合约账户还有新的变量：code，storage。

> 计数器在这里名为nonce，这个和比特币的nonce完全不一样，请注意。

### 以太坊的状态树

我们需要完成的是：**账户地址到账户状态的映射**。

以太坊的地址为160位，也就是40个字节，所以表示成40个16进制的数。

状态包括：余额、交易次数（nonce）、代码和存储（只在合约账户）。

我们要设计一个什么数据结构来维护这个映射呢？

一个直观的想法是，直接使用一个<u>哈希表</u>来实现，系统中的全节点维护一个哈希表，每次查询账户的余额都用一次哈希映射来解决，这样查找和更新都能在常数时间完成，听起来是个不错的设计。

这样做有什么问题呢？问题在于，哈希表怎样提供merkle proof。对于哈希表，每次构建merkle tree的效率太低了。如果只使用一棵merkle tree来储存所有账户，那么每次查找和更新的效率又太低了。

### Trie（字典树/前缀树）

略。

> 关于字典树，可以看我写过的博客：[数据结构](https://cescdf.com/blog/202104/mid-level-data-structure#%E5%AD%97%E5%85%B8%E6%A0%91%EF%BC%88%E5%89%8D%E7%BC%80%E6%A0%91%EF%BC%89)。

我们已经说过，以太坊的地址被表示为40个16进制的数，Trie的查找效率取决于键key的长度，这里的key长度固定为40。

### MPT（Merkle Patricia Tree）

**MPT：经过路径压缩的前缀树，并且树的形式是Merkle tree，即指向左右子节点的哈希指针替换了普通指针。**

用处：

1. 防止篡改；
2. Merkle proof of membership，能证明账户余额（自底向上发送余额消息）；
3. 也能证明non-membership；

以太坊用的不是原生的MPT，而是MMPT（Modified MPT），如下

![mmpt](https://cescdf.com/image/mmpt.png)

每产生一次交易，会在新的区块里更新分支，但树中大部分的节点都是复用的，（虽然新建了MMPT，但是大部分是共享的），

![mmptdiff](https://cescdf.com/image/mmptdiff.png)

上图中，右边是新的区块，右下角就是更新的部分。

为什么要保留历史信息呢？

1. audit，为了审查
2. 回滚（roll back）：取消不在最长合法链上的交易，因为有一些交易可能需要撤销（undo）
3. 以太坊的智能合约是图灵完备的，如果不保存以前的状态，智能合约执行完之后，要回滚是不可能的，所以必须保存。

