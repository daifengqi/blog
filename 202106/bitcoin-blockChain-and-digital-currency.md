# 比特币、区块链与数字货币

# Bitcoin, BlockChain and Digital Currency

## 2021 年 6 月 17 日

## Jun 17 2021



> 这是英文版的总结，中文版请参考另外两篇博客。



### Lecture 1-2 Crypto And Crypto Currencies

**🌟What is hash function**

1. input can be any string of any size
2. fixed-size output
3. efficiently computed, `O(n)`

**🌟What is cryptographic hash function**

as a hash function, it mush additionally have three security properties,

1. collision resistance
2. hiding
3. puzzle friendliness

**🌟What are collision-resistance, hiding and puzzle-friendliness**

- collision resistance

it is infeasible to find two values `x `and `y` such that `H(x) = H(y)`

> no hash has been prove collision-free

<u>applicaiton</u>: if we know that  `H(x) = H(y)`, it is safe to assume that `x = y`

- hiding

Given `H(x)`, it is infeasible to find `x`. A hash function is hiding if a secret value `r` is chose from a probability distribution that has high min-entropy, then, given `H(r || x)`, it is in feasible to find x.

<u>application</u>: seal a value in an envelope

> com := commit(msg, key)
>
> verify(com, msg, key) returns true if com = commit(msg, key) and false other wise.

- puzzle friendliness

for every possible n-bit output value `y`, if `k` is chose from a distribution with high min-entropy, then it is infeasible to find `x` such that `H(k || x) = y` in time significantly less that `2^n`.

> Avalanche effect: a small change of input will produce large change of output

**🌟Hash Pointer**

Pointer to where info is stored and (cryptographic) hash of the info.

- get the info back
- verify it hasn't change

**🌟Merkle tree**

a binary tree using hash pointer instead of pointer when point to node's left and right side of nodes.

The function of a merkle:

- prove membership in a merkle tree

- prove non-membership (sorted merkle tree)

**🌟Block Header**

1. Previous block hash
2. nonce
3. merkle tree

> `blockID = H(blockHeader) = H( P || N || M)`

**🌟Digital Signatures**

digital signature consists of 3 algorithms,

1. (sk, pk) := generateKeys(keysize), sk is used to sign messages and pk is to verify.
2. sig := sign(sk, msg)
3. verify(pk, msg, sig)

### Lecture 3-4 Decentralization

**🌟layers of network**

- application layer: Bitcoin Blockchain (Distributed consensus protocol)
- network layer: P2P network

Simple, robust, best-effort, not very efficient

**🌟transactions**

- transactions are generated by nodes
- when generated, it gets broadcasted into the P2P network
  - coinbase transaction by miners
  - transfer transaction by users

**🌟block and transactions**

- transactions are packages by miner nodes into a block
- block gets broadcasted via the P2P network
- transactions already packages into blockchain will be marked by nodes to be excluded when packaging new blocks

**🌟UTXO**

UTXO refers to unspent transaction output.

> any coin can be created once and consumed only once!

- each node keeps a set of UTXO
- each nodes verifies the blockchain and updates the UTXO

**🌟how bitcoin achieves consensus**

- Introduces <u>incentives</u> (it is currency!)
- Embraces <u>randomness</u> (no specific end-point or super node; consensus happens over long time scales, about 1 hour)

**🌟how bitcoin decentralization**

consensus algorithm,

1. new transactions are broadcast to all nodes
2. each node collects new transactions into a block
3. in each round a random node gets to broadcast its block
4. other nodes accept the block on if all transactions are valid
5. nodes express their acceptance of the block by including its hash in the next block they create

**🌟what can a malicious node do**

1. stealling bitcoins
2. denial-of-service
3. double-spend attack

Solutions:

1. signature
2. eventually honest node will include the transaction
3. hoest nodes will extend the <u>longest valid branch</u>

**🌟incentives and proof of work**

block reward!

> block creator gets to collect the reward only if the block ends up on long-term consensus branch.

transaction fee!

> Transaction fees become increasingly important, as block rewards start running out.

**🌟How to pick a random node?**

- BTC: In proportion to computing power: **proof-of-work**

> proof-of-work is so called "hash puzzles". H(blockID) < target.

three properties,

1. difficult to compute
2. parameterizable
3. trivial to verify

> Adjust difficulty to meet 10-minute goal.
>
> Why? make sure everyone working at the same true block.

- ETH: In proportion to ownership: **proof-of-stake**

**🌟How to avoid a free-for-all due to rewards?**

membership and incentive

**🌟How to prevent Sybil attacks?**

proof of work

**🌟three types of consensus**

1. value
2. state
3. rules

> bootstrapping a cryptocurrency
>
> - Security of blockchian
> - value of currency
> - health of mining ecosystem

**🌟51% attack**

- suppress some transactions from the block chian (fork attack)
- Destroy confidence!

Cannot steal coins, or change the reward.

### Lecture 5-6 Mechanics Of Bitcoin

**🌟script**

...

**🌟Design goals of script**

- built for bitcoin
- simple, compact
- stack-based
- no looping
- support for cryptography
- limits on time/memory
- not turing complete

**🌟proof of burn**

this script can never be redeemed.

uses: 

- Destroy coins and transfer them to alternative currency
- add arbitrary data to block chain

**P2SH**

Bob

1. creates a redeemScript
2. hashes the redeem script
3. sends to Alice

Alice

1. creates a output that contains the redeemScript hash

When Bob wants to spend,

1. Provides signature and the redeem script

P2P network

1. redeem script hashes to the same value that in the output
2. check the redeem script
3. Let Bob use the output if redeem scirpt does not return false

**🌟Application of Bitcoin scripts**

1. Escrow Transactions
2. Green Addresses
3. Efficient Micro-payments

> Pay 100 to Alice, lock until time `t`.

**🌟coinbase transaction**

- single input and single output
- hash pointer is null
- output value is miner's revenue
- output value = mining reward + transaction fees
- transaction fees come from all transactions
- Special coinbase parameter (any words)

### Lecture 7 Bitcoin Network and Fork

**🌟bitcoin P2P network**

- Ad-hoc protocol (TCP port 8333)
- random topology
- all nodes are equal
- join at anytime
- Forget non-responding nodes after 3hr

which kind of <u>transaction</u> can be relayed?

- script matches the whitelist
- haven't see before
- does not conflict

which kind of <u>block</u> can be relayed?

- meets the hash target
- run all scripts(even if you wouldn't relay), all valid transactions
- build on current longest valid chain

**🌟full nodes v.s. fully-validating nodes**

the latter,

- Permanently connected
- store entire block chain
- hear and forward every node/transaction

**🌟hard-coded limits**

- 10 min average creation time per block
- 1 M bytes in a block
- 20k signature operations per block
- 1 bit = 100 M (10 ^8) satoshi
- reward half every 21 thousand (210000) blocks
- 21 million (21 * 10^6) total bitcoins maximum
- 50,25,12.5... bitcoin mining

**🌟hard fork and soft fork**

Hard fork: change introduces new features that were previously invalid;

Soft fork: change introduces new features that make validation rules stricter.

> soft fork possibilitiyies
>
> - new signatures schemes
> - extra per-block metadata
> - stricter formatting of the coinbase transaction
> - add merkle tree of UTXOs

### Lecture 8 Store and Use Bitcoins

**🌟Online wallets and Exchanges**

> Online wallets: when you buy BTC, no BTC transaction appears on the blockchain.

How to prove how much reserve you are holding?

1. Publish a valid pay-to-self of claimed amount
2. Sign challenge string with same private key

**🌟Consensus transaction fees**

No fee if 

- tx < 1000 B
- all outputs are 0.01 BTC or larger
- priority is large enough

Priority = sum(inputAge * inputValue) / (tx_size)

Approx tx size: 148Ninputs + 34Noutputs + 10

**🌟Three key roles of miners**

Bitcoin depends on miners to

- Store and broadcast the block chain
- Validate new transactions
- Vote (by hash power) on consensus

**🌟Mining Bitcoins in 6 Easy Steps**

1. <u>Join</u> the network, listen for transactions
2. <u>listen</u> for new blocks, maintain block chain
3. <u>Assemble</u> a new valid block
4. Find the <u>nonce</u> to make the block valid
5. Hope everybody accepts your new block
6. profit

**🌟Mining Difficulty**

Next_difficulty = prev_difficulty * (2 weeks) / (time to mine last 2016 blocks)

> Expected number of blocks in 2 weeks at 10 minutes/block

**🌟Game Theoretical**

Several strategic decisions,

- which <u>transactions</u> to include in a block
  - default: any above minimum transaction fee
- which <u>block</u> to mine
  - default: longest valid chain
- how to choose between <u>colliding</u> blocks
  - default: first block heard
- when to announce <u>new</u> blocks
  - default: immediately after finding them

**🌟Bribery to get more than half mining power for forking attacts**

1. Out-of-band bribery
2. run a mining pool at a loss
3. insert large "tips" in the block chain

**Energy Aspects of Bitcoin Mining**

- Embodied Energy
  - used to manufacture mining chips & other equipment
  - should decrease over time
  - returns to scale

- Electricity
  - used to perform computation
  - should increase over time
  - returns to scale

- Cooling
  - required to protect equipment
  - costs more with increased scale!

### Lecture 9 Ethereum

Overview,

- Distributed computer to execute code
- Account-based blockchain
- Transactions == state transaction function
- Blocks == snapshots of state machines

**🌟externally owned account and Contract account**

externally,

- nonce
- balance

Contract plus,

- code: hash of the EVM (Ethereum Virtual Machine) code of this account
- storageRoot: hash of the merkle root

different,

- ex can start a transfer or trigger contract account to run ode
- anyone can create, publicly accessible and anyone can call

> 1 ether = 10^18 Wei
>
> 1 bitcoin = 1 hundred million satoshi (10^8)

**🌟what is the difference in <u>nonce</u> of Bitcoin and Ethereum**

...

The whole network becomes **a distributed state machine** and the block chain keeps track of the change of states.
